---
title: "OrthoPaiR Package Vignette"
author: "Tomoyuki Furuta"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{OrthoPaiR Package Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

# Introduction

`OrthoPaiR` is an R package for identifying **syntenic orthologous genes** across multiple genomes.
The main user-facing workflow consists of:

1. Preparing a list of input files with `orgInputFiles()`.
2. Running the full pipeline with `orthopair()`.
3. Exploring ortholog pairs and orphans from the output files.

This vignette explains how to prepare inputs, run the pipeline for two or more genomes, and interpret the output files.

# Prerequisites

```{r, eval=FALSE}
install.packages("devtools")
install.packages("BiocManager")

BiocManager::install(c(
  "GenomicRanges", "GenomeInfoDb", "GenomicFeatures",
  "rhdf5", "BiocGenerics", "Biobase", "IRanges",
  "rtracklayer", "Biostrings", "S4Vectors", "BSgenome"
))

install.packages(c("parallel", "ggplot2", "dplyr"))
```

External command‑line tools:

- **BLAST+** (`makeblastdb`, `blastn` in `blast_path`) – required for DNA sequence similarity; `blastp` is required only when `use_prot = TRUE` for protein sequence similarity.
- **DIAMOND** (`diamond` in `diamond_path`) – required when `use_prot = TRUE` for protein sequence similarity.
- **Miniprot** (optional; only if `run_miniprot = TRUE` to predict missing ORFs) – requires genome FASTA files in `orgInputFiles()`.

# Preparing input files with `orgInputFiles()`

The function `orgInputFiles()` collects file paths for each genome and performs basic validation.
You call it once per genome, optionally appending to an existing input object:

```{r, eval=FALSE}
library(OrthoPaiR)

in_list <- orgInputFiles(
  name   = "Osat",
  genome = NA,                            # optional genome FASTA
  gff    = "path/to/osat.gff",
  cds    = "path/to/osat_cds.fa",
  prot   = "path/to/osat_prot.fa"         # optional; NA if not used
)

in_list <- orgInputFiles(
  object = in_list,
  name   = "Hvul",
  genome = NA,
  gff    = "path/to/hvul.gff",
  cds    = "path/to/hvul_cds.fa",
  prot   = "path/to/hvul_prot.fa"
)
```

## Required GFF and FASTA formats

- **GFF3 file**
  - Must contain at least `gene` and transcript features (`mRNA` or `transcript`) and `CDS` features.
  - Must have a non‑empty `gene_id` column with no `NA`.
  - The `Parent` column of transcripts must match the `ID` of genes one‑to‑one (and vice versa).
- **CDS FASTA**
  - FASTA record names must correspond to `ID` values in the GFF (for CDS features).
  - All CDS names must be present in the GFF; otherwise `orgInputFiles()` stops with an error.
- **Protein FASTA** (only if `prot` is provided)
  - Protein record names must also match `ID` values in the same GFF.
- **Genome FASTA** (optional, but **required if `run_miniprot = TRUE`**)
  - If supplied, all `seqlevels(gff)` must be present in the genome FASTA sequence names.
  - **Important**: If you set `run_miniprot = TRUE` in `orthopair()` to reciprocally predict missing ORFs, you **must** provide the `genome` parameter (path to the genome FASTA file) for each genome in `orgInputFiles()`.

## Reformatting input files with `fixInputFiles()`

If your input files do not meet the requirements above, you can use `fixInputFiles()` to reformat them. This function helps prepare GFF, CDS, protein, and genome FASTA files to be compatible with OrthoPaiR.

```{r, eval=FALSE}
fixed_files <- fixInputFiles(
  genome = "path/to/genome.fa",    # optional
  gff    = "path/to/annotation.gff",
  cds    = "path/to/cds.fa",       # optional
  prot   = "path/to/prot.fa",      # optional
  autofix = FALSE                  # TRUE for automatic fixes
)
```

The function performs the following operations:

- **Genome FASTA reformatting** (if provided):
  - Renames sequence names to match GFF seqlevels (with interactive prompts or automatic renaming if `autofix = TRUE`).
  - Allows padding chromosome numbers and adding prefixes (e.g., "chr01", "chr02").
  - Enables removal of unwanted sequences.

- **GFF file reformatting**:
  - Drops unnecessary feature types, keeping only `gene`, `mRNA`/`transcript`, `exon`, and `CDS` features.
  - Ensures proper `ID` and `Parent` relationships between features.
  - Sets the `gene_id` column for all features.
  - Fixes `Parent` column entries to contain single values (required by OrthoPaiR).
  - Updates sequence names (seqlevels) to match the reformatted genome FASTA.

- **CDS and protein FASTA reformatting** (if provided):
  - Attempts to match FASTA record names with GFF `ID` values using multiple strategies:
    - Direct matching with `ID`, `transcript_id`, or `protein_id` columns.
    - Pattern-based matching (removing suffixes, extracting IDs from complex names).
  - If `autofix = TRUE`, automatically tries multiple matching strategies.
  - If matching fails and a genome FASTA is provided, creates new CDS and protein FASTA files from the GFF and genome sequences.

The function returns a list with paths to the reformatted files (with `.op_fixed` suffix):
- `fixed_files$gff`: reformatted GFF file
- `fixed_files$cds`: reformatted CDS FASTA (if provided)
- `fixed_files$prot`: reformatted protein FASTA (if provided)
- `fixed_files$genome`: reformatted genome FASTA (if provided)

You can then use these fixed files with `orgInputFiles()`:

```{r, eval=FALSE}
in_list <- orgInputFiles(
  name   = "Osat",
  genome = fixed_files$genome,
  gff    = fixed_files$gff,
  cds    = fixed_files$cds,
  prot   = fixed_files$prot
)
```

**Note**: When `autofix = FALSE` (default), the function will prompt you interactively for decisions about renaming sequences and fixing IDs. Set `autofix = TRUE` for automatic fixes, but be aware that automatic fixes may not always succeed if the input format is too different from expected formats.

# Running the pipeline with `orthopair()`

The high‑level pipeline is implemented in `orthopair()` (see `R/07_functions_pipeline.R`):

```{r, eval=FALSE}
wd <- "path/to/output/orthopair"

out_files <- orthopair(
  in_list      = in_list,
  working_dir  = wd,
  miniprot_path = "/path/to/miniprot/bin",
  blast_path    = "/path/to/blast/bin",
  diamond_path  = "/path/to/diamond/bin",
  n_threads     = 30,
  overwrite     = TRUE,
  target_pair   = NULL,
  use_prot      = FALSE,
  run_miniprot  = FALSE,
  orthopair     = TRUE,
  reorg         = TRUE,
  makegraph     = TRUE,
  output_table  = TRUE
)
```

For each pair of genomes in `in_list`, `orthopair()`:

1. Organises input data and creates per‑genome HDF5 files (`input/<name>/input.h5`).
2. Prepares pairwise input definitions and HDF5 output paths (`hdf5_out/*.h5`).
3. Runs reciprocal BLAST/DIAMOND searches and synteny‑aware ortholog pairing.
   - If `use_prot = FALSE` (default): uses BLAST+ for DNA sequence similarity searches.
   - If `use_prot = TRUE`: uses DIAMOND for protein sequence similarity searches instead of (or in addition to) DNA-based searches.
4. Optionally **reorganises orthopairs across all genomes** (`reorg = TRUE`).
5. Optionally **builds an orthology network graph** (`makegraph = TRUE`).
6. Optionally **exports ortholog tables** (`output_table = TRUE`).

The return value is a named character vector with paths to the final HDF5, graph, and table files.

## Two‑genome vs multi‑genome use

When you analyse **only two genomes**, you usually:

- Focus on the pairwise HDF5 file for that genome pair.
- Do **not need** to call the multi‑genome reorganisation and graph steps.

In this case you can leave:

- `reorg = FALSE`, `makegraph = FALSE`, and `output_table = FALSE`

and work directly from the HDF5 output for the single pair (e.g. `hdf5_out/Osat_Hvul.h5`).

When you analyse **three or more genomes**, setting:

- `reorg = TRUE`, `makegraph = TRUE`, and `output_table = TRUE`

enables OrthoPaiR to:

1. Merge pairwise orthopairs into a unified multi‑species representation (`reorg_out/reorg_orthopair.h5`).
2. Construct an orthology **network graph** (`orthopair.graphml`) where nodes are genes and edges connect orthologous genes.
3. Define ortholog groups based on graph connectivity and export them as tables (`orthopair_list.csv`, `orphan_list.csv`).

# Example: four‑genome analysis (sample script)

```{r, eval=FALSE}
root_dir   <- "/path/to/workspace/orthology"
input_dir  <- file.path(root_dir, "input")
output_dir <- file.path(root_dir, "output")

library(OrthoPaiR)

in_list <- orgInputFiles(
  name = "Osat",
  genome = NA,
  gff = file.path(input_dir, "osat.gff"),
  cds = file.path(input_dir, "osat_cds.fa"),
  prot = file.path(input_dir, "osat_prot.fa")
)

in_list <- orgInputFiles(
  object = in_list,
  name = "Hvul",
  genome = NA,
  gff = file.path(input_dir, "hvul.gff"),
  cds = file.path(input_dir, "hvul_cds.fa"),
  prot = file.path(input_dir, "hvul_prot.fa")
)

in_list <- orgInputFiles(
  object = in_list,
  name = "Atha",
  genome = NA,
  gff = file.path(input_dir, "atha.gff"),
  cds = file.path(input_dir, "atha_cds.fa"),
  prot = file.path(input_dir, "atha_prot.fa")
)

in_list <- orgInputFiles(
  object = in_list,
  name = "Mpol",
  genome = NA,
  gff = file.path(input_dir, "mpol.gff"),
  cds = file.path(input_dir, "mpol_cds.fa"),
  prot = file.path(input_dir, "mpol_prot.fa")
)

wd <- file.path(output_dir, "orthopair")

out_files <- orthopair(
  in_list      = in_list,
  working_dir  = wd,
  miniprot_path = "/path/to/miniprot/bin",
  blast_path    = "/path/to/blast/bin",
  diamond_path  = "/path/to/diamond/bin",
  n_threads     = 30,
  overwrite     = TRUE,
  verbose       = TRUE,
  use_prot      = FALSE,
  target_pair   = NULL,
  orthopair     = TRUE,
  run_miniprot  = FALSE,
  reorg         = TRUE,
  makegraph     = TRUE,
  output_table  = TRUE
)
```

This script corresponds to the contents of `sample_data/orthopair`, which you can use as a reference for expected outputs.

# Output files produced by `orthopair()`

The sample output in `sample_data/orthopair` illustrates the directory structure created by the pipeline:

When you run the pipeline, the output directory will have the following structure (example for four genomes and default parameters):

```
/your_working_dir/
├── hdf5_out/
│   ├── Osat_Hvul.h5
│   ├── Osat_Atha.h5
│   ├── Osat_Mpol.h5
│   ├── Hvul_Atha.h5
│   ├── Hvul_Mpol.h5
│   └── Atha_Mpol.h5
├── reorg_out/
│   ├── Osat_orthopair.gff
│   ├── Hvul_orthopair.gff
│   ├── Atha_orthopair.gff
│   ├── Mpol_orthopair.gff
│   └── reorg_orthopair.h5
├── input/
│   └── ... (per-genome input files and BLAST/DIAMOND databases)
├── orthopair_list.csv
├── orphan_list.csv
├── orthopair.graphml
└── ... (other possible intermediate or log files)
```

Each `*.h5` file is a pairwise result for two genomes. The summary tables and network files (e.g., `orthopair_list.csv`, `orthopair.graphml`) are generated when `reorg`, `makegraph`, or `output_table` are TRUE.

Detailed descriptions of the output files:

- **`input/<name>/`**
  - `cds.fa`, `prot.fa`: representative CDS/protein FASTA files.
  - `input.h5`: per‑genome HDF5 storing GFF, CDS (and optionally protein) information.
  - BLAST and DIAMOND index files (`cds.fa.n*`, `prot.fa.dmnd`).
- **`hdf5_out/*.h5`**
  - Pairwise orthology results for each genome pair (e.g. `Osat_Hvul.h5`).
  - These files contain the syntenic ortholog pairs and associated metadata for each pair.
- **`reorg_out/`** (when `reorg = TRUE`)
  - `<name>_orthopair.gff`: per‑genome GFF files where gene IDs are **reorganised** to reflect ortholog groups.
  - `reorg_orthopair.h5`: multi‑genome HDF5 combining orthopairs across all species.
- **`orthopair.graphml`** (when `makegraph = TRUE`)
  - Graph representation of ortholog relationships.
  - Nodes are genes, edges connect orthologous genes inferred from pairwise comparisons.
- **`orthopair_list.csv` and `orphan_list.csv`** (when `output_table = TRUE`)
  - Generated from the graph (`graph2df()` and `getOrphan()` in `R/07_functions_pipeline.R`).
  - `orthopair_list.csv`: table of ortholog groups; each row corresponds to a graph‑defined group, with columns for each genome.
  - `orphan_list.csv`: table of genes without orthologs (orphans), again with columns for each genome.
- **`runtime.csv`**
  - Summarises runtime statistics for the main steps of the pipeline.

For two‑genome analyses, you can work primarily with the single pairwise HDF5 file in `hdf5_out`.
For multi‑genome analyses, the reorganised HDF5 (`reorg_out/reorg_orthopair.h5`), graph (`orthopair.graphml`), and CSV tables (`orthopair_list.csv`, `orphan_list.csv`) provide a convenient basis for downstream comparative genomics.

